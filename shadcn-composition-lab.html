<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Shadcn Component Composition Lab — Akriva</title>
<style>
  /* ── Akriva Design Tokens ── */
  :root {
    --background: #f7f8f9;
    --foreground: #1e293b;
    --card: #ffffff;
    --card-foreground: #1e293b;
    --primary: #2563eb;
    --primary-foreground: #ffffff;
    --secondary: #f1f5f9;
    --secondary-foreground: #1e293b;
    --muted: #f1f5f9;
    --muted-foreground: #64748b;
    --destructive: #ef4444;
    --destructive-foreground: #ffffff;
    --border: #e5e7eb;
    --input: #e5e7eb;
    --ring: #2563eb;
    --accent: #f1f5f9;
    --accent-foreground: #1e293b;
    --radius-sm: 0px;
    --radius-md: 2px;
    --radius-lg: 4px;
    --radius-xl: 8px;
    --shadow-sm: 0 2px 4px 0 rgba(30,41,59,0.06);
    --shadow: 0 2px 4px 0 rgba(30,41,59,0.06), 0 1px 2px -1px rgba(30,41,59,0.04);
    --shadow-md: 0 4px 8px -1px rgba(30,41,59,0.08);

    /* Playground UI (dark chrome) */
    --ui-bg: #0f1117;
    --ui-surface: #1a1d27;
    --ui-surface-hover: #242833;
    --ui-border: #2a2e3a;
    --ui-text: #e2e4ea;
    --ui-text-muted: #8b8fa3;
    --ui-accent: #2563eb;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    background: var(--ui-bg);
    color: var(--ui-text);
    height: 100vh;
    overflow: hidden;
  }

  /* ── Three-Panel Layout ── */
  .app {
    display: grid;
    grid-template-columns: 240px 1fr 340px;
    height: 100vh;
  }

  /* ── Left Sidebar: Component Palette ── */
  .palette {
    background: var(--ui-surface);
    border-right: 1px solid var(--ui-border);
    overflow-y: auto;
    display: flex;
    flex-direction: column;
  }

  .palette-header {
    padding: 16px;
    border-bottom: 1px solid var(--ui-border);
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--ui-text-muted);
  }

  .palette-category {
    padding: 8px 0;
  }

  .palette-category-title {
    padding: 4px 16px;
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--ui-text-muted);
  }

  .palette-item {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 6px 16px;
    cursor: pointer;
    font-size: 13px;
    color: var(--ui-text);
    transition: background 0.15s;
    border: none;
    background: none;
    width: 100%;
    text-align: left;
  }

  .palette-item:hover {
    background: var(--ui-surface-hover);
  }

  .palette-item .icon {
    width: 16px;
    height: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 10px;
    color: var(--ui-text-muted);
    flex-shrink: 0;
  }

  .palette-item.sub {
    padding-left: 32px;
    font-size: 12px;
    color: var(--ui-text-muted);
  }

  .palette-item.sub:hover {
    color: var(--ui-text);
  }

  /* ── Center: Canvas ── */
  .canvas-area {
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .canvas-toolbar {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 16px;
    background: var(--ui-surface);
    border-bottom: 1px solid var(--ui-border);
    min-height: 44px;
  }

  .canvas-toolbar button {
    background: var(--ui-surface-hover);
    border: 1px solid var(--ui-border);
    color: var(--ui-text);
    padding: 4px 10px;
    border-radius: 4px;
    font-size: 12px;
    cursor: pointer;
    transition: background 0.15s;
  }

  .canvas-toolbar button:hover {
    background: #2f3340;
  }

  .canvas-toolbar button:disabled {
    opacity: 0.3;
    cursor: not-allowed;
  }

  .canvas-toolbar button.danger {
    color: var(--destructive);
  }

  .canvas-toolbar .separator {
    width: 1px;
    height: 20px;
    background: var(--ui-border);
  }

  .canvas-toolbar .breadcrumb {
    font-size: 12px;
    color: var(--ui-text-muted);
    margin-left: 8px;
    flex: 1;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .canvas-toolbar .breadcrumb span {
    color: var(--ui-text);
  }

  .canvas-viewport {
    flex: 1;
    overflow: auto;
    padding: 32px;
    display: flex;
    justify-content: center;
    align-items: flex-start;
  }

  /* Preview area renders with Akriva tokens */
  .preview-frame {
    background: var(--background);
    color: var(--foreground);
    font-family: "Inter", system-ui, -apple-system, sans-serif;
    min-width: 480px;
    max-width: 720px;
    width: 100%;
    min-height: 200px;
    border-radius: 8px;
    padding: 24px;
    box-shadow: 0 0 0 1px rgba(255,255,255,0.06);
  }

  .preview-empty {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 300px;
    color: var(--muted-foreground);
    font-size: 14px;
    gap: 8px;
  }

  .preview-empty .hint {
    font-size: 12px;
    opacity: 0.7;
  }

  /* ── Component rendering in preview ── */
  .prev-node {
    position: relative;
    cursor: pointer;
    transition: outline 0.1s;
    outline: 2px solid transparent;
    outline-offset: 2px;
  }

  .prev-node.selected {
    outline: 2px solid var(--ring);
    outline-offset: 2px;
  }

  .prev-node:hover:not(.selected) {
    outline: 2px solid rgba(37,99,235,0.3);
    outline-offset: 2px;
  }

  /* Akriva-styled components inside preview */
  .prev-card { background: var(--card); border: 1px solid var(--border); border-radius: var(--radius-xl); box-shadow: var(--shadow-sm); padding: 0; }
  .prev-card-header { display: flex; flex-direction: column; gap: 6px; padding: 24px 24px 0; }
  .prev-card-title { font-size: 18px; font-weight: 600; color: var(--card-foreground); line-height: 1.3; }
  .prev-card-description { font-size: 14px; color: var(--muted-foreground); line-height: 1.5; }
  .prev-card-content { padding: 24px; display: flex; flex-direction: column; gap: 16px; }
  .prev-card-footer { padding: 0 24px 24px; display: flex; gap: 8px; justify-content: flex-end; }

  .prev-separator { height: 1px; background: var(--border); width: 100%; margin: 8px 0; }

  .prev-input { height: 36px; width: 100%; border: 1px solid var(--input); border-radius: var(--radius-md); padding: 0 12px; font-size: 14px; background: transparent; color: var(--foreground); font-family: inherit; }
  .prev-input::placeholder { color: var(--muted-foreground); }

  .prev-textarea { width: 100%; min-height: 80px; border: 1px solid var(--input); border-radius: var(--radius-md); padding: 8px 12px; font-size: 14px; background: transparent; color: var(--foreground); font-family: inherit; resize: vertical; }

  .prev-label { font-size: 14px; font-weight: 500; color: var(--foreground); }

  .prev-button { display: inline-flex; align-items: center; justify-content: center; height: 36px; padding: 0 16px; font-size: 14px; font-weight: 500; border-radius: var(--radius-md); cursor: default; border: none; font-family: inherit; transition: background 0.15s; }
  .prev-button.default { background: var(--primary); color: var(--primary-foreground); }
  .prev-button.secondary { background: var(--secondary); color: var(--secondary-foreground); }
  .prev-button.outline { background: transparent; border: 1px solid var(--input); color: var(--foreground); }
  .prev-button.destructive { background: var(--destructive); color: var(--destructive-foreground); }
  .prev-button.ghost { background: transparent; color: var(--foreground); }
  .prev-button.sm { height: 32px; padding: 0 12px; font-size: 13px; }
  .prev-button.lg { height: 44px; padding: 0 24px; font-size: 16px; }

  .prev-badge { display: inline-flex; align-items: center; padding: 2px 10px; font-size: 12px; font-weight: 500; border-radius: 9999px; }
  .prev-badge.default { background: var(--primary); color: var(--primary-foreground); }
  .prev-badge.secondary { background: var(--secondary); color: var(--secondary-foreground); }
  .prev-badge.outline { background: transparent; border: 1px solid var(--border); color: var(--foreground); }
  .prev-badge.destructive { background: var(--destructive); color: var(--destructive-foreground); }

  .prev-checkbox-row { display: flex; align-items: center; gap: 8px; }
  .prev-checkbox { width: 16px; height: 16px; border: 1px solid var(--primary); border-radius: var(--radius-sm); appearance: none; cursor: default; position: relative; background: transparent; }
  .prev-checkbox:checked { background: var(--primary); }
  .prev-checkbox:checked::after { content: ""; position: absolute; left: 4.5px; top: 1.5px; width: 4px; height: 8px; border: solid var(--primary-foreground); border-width: 0 2px 2px 0; transform: rotate(45deg); }

  .prev-switch-row { display: flex; align-items: center; gap: 8px; }
  .prev-switch { width: 44px; height: 24px; border-radius: 9999px; background: var(--input); position: relative; cursor: default; border: none; transition: background 0.2s; }
  .prev-switch.on { background: var(--primary); }
  .prev-switch .thumb { position: absolute; top: 2px; left: 2px; width: 20px; height: 20px; border-radius: 9999px; background: white; transition: transform 0.2s; box-shadow: 0 1px 3px rgba(0,0,0,0.15); }
  .prev-switch.on .thumb { transform: translateX(20px); }

  .prev-select { height: 36px; width: 100%; border: 1px solid var(--input); border-radius: var(--radius-md); padding: 0 12px; font-size: 14px; background: transparent; color: var(--muted-foreground); font-family: inherit; appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%2364748b' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 12px center; }

  .prev-progress { width: 100%; height: 8px; background: var(--secondary); border-radius: 9999px; overflow: hidden; }
  .prev-progress-bar { height: 100%; background: var(--primary); border-radius: 9999px; width: 60%; }

  .prev-skeleton { background: var(--muted); border-radius: var(--radius-md); animation: skeleton-pulse 2s ease-in-out infinite; }
  @keyframes skeleton-pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

  .prev-alert { display: flex; gap: 12px; padding: 16px; border: 1px solid var(--border); border-radius: var(--radius-lg); background: var(--card); }
  .prev-alert.destructive { border-color: var(--destructive); }
  .prev-alert-icon { flex-shrink: 0; width: 16px; height: 16px; margin-top: 2px; color: var(--foreground); }
  .prev-alert.destructive .prev-alert-icon { color: var(--destructive); }
  .prev-alert-content { flex: 1; }
  .prev-alert-title { font-size: 14px; font-weight: 600; margin-bottom: 4px; }
  .prev-alert-description { font-size: 14px; color: var(--muted-foreground); }

  .prev-avatar { width: 40px; height: 40px; border-radius: 9999px; background: var(--muted); display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 600; color: var(--muted-foreground); overflow: hidden; flex-shrink: 0; }

  .prev-tabs-list { display: flex; gap: 0; background: var(--muted); border-radius: var(--radius-md); padding: 4px; }
  .prev-tab { padding: 6px 16px; font-size: 14px; font-weight: 500; border-radius: var(--radius-sm); cursor: default; border: none; background: transparent; color: var(--muted-foreground); font-family: inherit; }
  .prev-tab.active { background: var(--card); color: var(--foreground); box-shadow: var(--shadow-sm); }

  .prev-radio-group { display: flex; flex-direction: column; gap: 8px; }
  .prev-radio-row { display: flex; align-items: center; gap: 8px; }
  .prev-radio { width: 16px; height: 16px; border: 1px solid var(--primary); border-radius: 9999px; appearance: none; cursor: default; position: relative; background: transparent; }
  .prev-radio:checked::after { content: ""; position: absolute; top: 3px; left: 3px; width: 8px; height: 8px; border-radius: 9999px; background: var(--primary); }

  .prev-field-group { display: flex; flex-direction: column; gap: 20px; }
  .prev-field-set { display: flex; flex-direction: column; gap: 8px; }
  .prev-field-legend { font-size: 16px; font-weight: 600; color: var(--foreground); }
  .prev-field-description { font-size: 14px; color: var(--muted-foreground); }

  .prev-breadcrumb { display: flex; align-items: center; gap: 6px; font-size: 14px; }
  .prev-breadcrumb-item { color: var(--muted-foreground); }
  .prev-breadcrumb-item.current { color: var(--foreground); font-weight: 500; }
  .prev-breadcrumb-sep { color: var(--muted-foreground); }

  /* Container children layout */
  .container-children { display: flex; flex-direction: column; gap: 16px; }

  /* ── Right Panel: Props + Code ── */
  .right-panel {
    background: var(--ui-surface);
    border-left: 1px solid var(--ui-border);
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .right-tabs {
    display: flex;
    border-bottom: 1px solid var(--ui-border);
  }

  .right-tab {
    flex: 1;
    padding: 10px;
    text-align: center;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    cursor: pointer;
    background: none;
    border: none;
    color: var(--ui-text-muted);
    border-bottom: 2px solid transparent;
    transition: all 0.15s;
  }

  .right-tab.active {
    color: var(--ui-text);
    border-bottom-color: var(--ui-accent);
  }

  .right-content {
    flex: 1;
    overflow-y: auto;
    padding: 16px;
  }

  .right-content.hidden {
    display: none;
  }

  /* Props controls */
  .prop-group {
    margin-bottom: 16px;
  }

  .prop-label {
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: var(--ui-text-muted);
    margin-bottom: 6px;
  }

  .prop-input {
    width: 100%;
    background: var(--ui-bg);
    border: 1px solid var(--ui-border);
    color: var(--ui-text);
    padding: 6px 10px;
    border-radius: 4px;
    font-size: 13px;
    font-family: inherit;
  }

  .prop-input:focus {
    outline: none;
    border-color: var(--ui-accent);
  }

  .prop-select {
    width: 100%;
    background: var(--ui-bg);
    border: 1px solid var(--ui-border);
    color: var(--ui-text);
    padding: 6px 10px;
    border-radius: 4px;
    font-size: 13px;
    font-family: inherit;
  }

  .prop-toggle {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .prop-toggle input[type="checkbox"] {
    accent-color: var(--ui-accent);
  }

  .prop-toggle label {
    font-size: 13px;
    color: var(--ui-text);
    cursor: pointer;
  }

  .no-selection {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 200px;
    color: var(--ui-text-muted);
    font-size: 13px;
    text-align: center;
    gap: 4px;
  }

  /* Code output */
  .code-block {
    background: var(--ui-bg);
    border: 1px solid var(--ui-border);
    border-radius: 6px;
    overflow: hidden;
  }

  .code-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 12px;
    border-bottom: 1px solid var(--ui-border);
  }

  .code-lang {
    font-size: 11px;
    font-weight: 600;
    color: var(--ui-text-muted);
    text-transform: uppercase;
  }

  .copy-btn {
    background: var(--ui-surface-hover);
    border: 1px solid var(--ui-border);
    color: var(--ui-text);
    padding: 3px 10px;
    border-radius: 4px;
    font-size: 11px;
    cursor: pointer;
    transition: all 0.15s;
  }

  .copy-btn:hover {
    background: #2f3340;
  }

  .copy-btn.copied {
    background: #16a34a;
    border-color: #16a34a;
    color: white;
  }

  .code-body {
    padding: 12px;
    font-family: "JetBrains Mono", "SF Mono", "Fira Code", monospace;
    font-size: 12px;
    line-height: 1.6;
    white-space: pre-wrap;
    word-break: break-word;
    color: var(--ui-text);
    max-height: calc(100vh - 200px);
    overflow-y: auto;
  }

  /* Syntax highlighting (minimal) */
  .syn-kw { color: #c678dd; }
  .syn-str { color: #98c379; }
  .syn-tag { color: #e06c75; }
  .syn-attr { color: #d19a66; }
  .syn-cmt { color: #5c6370; font-style: italic; }

  /* Presets bar */
  .presets-bar {
    padding: 8px 16px;
    border-bottom: 1px solid var(--ui-border);
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
  }

  .preset-btn {
    background: var(--ui-surface-hover);
    border: 1px solid var(--ui-border);
    color: var(--ui-text-muted);
    padding: 4px 12px;
    border-radius: 4px;
    font-size: 11px;
    cursor: pointer;
    transition: all 0.15s;
  }

  .preset-btn:hover {
    color: var(--ui-text);
    border-color: var(--ui-accent);
  }

  /* Scrollbar styling */
  ::-webkit-scrollbar { width: 6px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--ui-border); border-radius: 3px; }
  ::-webkit-scrollbar-thumb:hover { background: #3a3e4a; }
</style>
</head>
<body>

<div class="app">
  <!-- Left: Component Palette -->
  <div class="palette">
    <div class="palette-header">Components</div>
    <div id="palette-list"></div>
  </div>

  <!-- Center: Canvas -->
  <div class="canvas-area">
    <div class="canvas-toolbar">
      <button id="btn-move-up" title="Move up" disabled>&#9650;</button>
      <button id="btn-move-down" title="Move down" disabled>&#9660;</button>
      <div class="separator"></div>
      <button id="btn-delete" class="danger" title="Delete" disabled>&#10005; Delete</button>
      <div class="separator"></div>
      <button id="btn-clear" class="danger" title="Clear all">Clear All</button>
      <div class="breadcrumb" id="breadcrumb"></div>
    </div>
    <div class="presets-bar">
      <span style="font-size:11px;color:var(--ui-text-muted);margin-right:4px;line-height:26px;">Presets:</span>
      <button class="preset-btn" onclick="loadPreset('login')">Login Form</button>
      <button class="preset-btn" onclick="loadPreset('settings')">Settings Card</button>
      <button class="preset-btn" onclick="loadPreset('profile')">Profile Card</button>
      <button class="preset-btn" onclick="loadPreset('alert')">Alert Banner</button>
      <button class="preset-btn" onclick="loadPreset('empty')">Empty State</button>
    </div>
    <div class="canvas-viewport">
      <div class="preview-frame" id="preview"></div>
    </div>
  </div>

  <!-- Right: Props + Code -->
  <div class="right-panel">
    <div class="right-tabs">
      <button class="right-tab active" onclick="switchTab('props')">Props</button>
      <button class="right-tab" onclick="switchTab('code')">Code</button>
    </div>
    <div class="right-content" id="props-panel">
      <div class="no-selection" id="no-selection">
        <div>No component selected</div>
        <div style="font-size:11px;opacity:0.7;">Click a component on the canvas or add one from the palette</div>
      </div>
      <div id="props-form" style="display:none;"></div>
    </div>
    <div class="right-content hidden" id="code-panel">
      <div class="code-block">
        <div class="code-header">
          <span class="code-lang">Svelte</span>
          <button class="copy-btn" id="copy-btn" onclick="copyCode()">Copy</button>
        </div>
        <div class="code-body" id="code-output"></div>
      </div>
    </div>
  </div>
</div>

<script>
// ═══════════════════════════════════════════════════
// Component Definitions
// ═══════════════════════════════════════════════════

const COMPONENTS = {
  // Layout
  'Card': { category: 'Layout', icon: '▭', isContainer: true, importNs: 'Card', importPath: '$lib/components/ui/card/index.js',
    props: { },
    subParts: ['Card.Header', 'Card.Title', 'Card.Description', 'Card.Content', 'Card.Footer'],
  },
  'Card.Header': { category: '_sub', icon: '▔', isContainer: true, partOf: 'Card', importNs: 'Card', importPath: '$lib/components/ui/card/index.js', props: {} },
  'Card.Title': { category: '_sub', icon: 'T', importNs: 'Card', importPath: '$lib/components/ui/card/index.js',
    props: { text: { type: 'text', label: 'Text', default: 'Card Title' } },
  },
  'Card.Description': { category: '_sub', icon: 'D', importNs: 'Card', importPath: '$lib/components/ui/card/index.js',
    props: { text: { type: 'text', label: 'Text', default: 'Card description text' } },
  },
  'Card.Content': { category: '_sub', icon: '▢', isContainer: true, partOf: 'Card', importNs: 'Card', importPath: '$lib/components/ui/card/index.js', props: {} },
  'Card.Footer': { category: '_sub', icon: '▁', isContainer: true, partOf: 'Card', importNs: 'Card', importPath: '$lib/components/ui/card/index.js', props: {} },
  'Separator': { category: 'Layout', icon: '―', importName: 'Separator', importPath: '$lib/components/ui/separator/index.js', props: {} },
  'Text': { category: 'Layout', icon: 'T', isRaw: true,
    props: {
      text: { type: 'text', label: 'Content', default: 'Your text here' },
      style: { type: 'select', label: 'Style', options: ['body', 'heading', 'subheading', 'small', 'muted'], default: 'body' },
    },
  },
  'Field.Group': { category: 'Layout', icon: '⊞', isContainer: true, importNs: 'Field', importPath: '$lib/components/ui/field/index.js', props: {},
    subParts: ['Field.Set', 'Field.Legend', 'Field.Description', 'Field.Separator'],
  },
  'Field.Set': { category: '_sub', icon: '⊟', isContainer: true, partOf: 'Field.Group', importNs: 'Field', importPath: '$lib/components/ui/field/index.js', props: {} },
  'Field.Legend': { category: '_sub', icon: 'L', importNs: 'Field', importPath: '$lib/components/ui/field/index.js',
    props: { text: { type: 'text', label: 'Text', default: 'Section Title' } },
  },
  'Field.Description': { category: '_sub', icon: 'D', importNs: 'Field', importPath: '$lib/components/ui/field/index.js',
    props: { text: { type: 'text', label: 'Text', default: 'Helper text' } },
  },
  'Field.Separator': { category: '_sub', icon: '―', partOf: 'Field.Group', importNs: 'Field', importPath: '$lib/components/ui/field/index.js', props: {} },

  // Form
  'Button': { category: 'Form', icon: '⬡', importName: 'Button', importPath: '$lib/components/ui/button/index.js',
    props: {
      text: { type: 'text', label: 'Label', default: 'Button' },
      variant: { type: 'select', label: 'Variant', options: ['default', 'secondary', 'outline', 'destructive', 'ghost'], default: 'default' },
      size: { type: 'select', label: 'Size', options: ['default', 'sm', 'lg'], default: 'default' },
    },
  },
  'Input': { category: 'Form', icon: '▭', importName: 'Input', importPath: '$lib/components/ui/input/index.js',
    props: {
      placeholder: { type: 'text', label: 'Placeholder', default: 'Enter value...' },
      type: { type: 'select', label: 'Type', options: ['text', 'email', 'password', 'number', 'url'], default: 'text' },
      disabled: { type: 'toggle', label: 'Disabled', default: false },
    },
  },
  'Textarea': { category: 'Form', icon: '▭', importName: 'Textarea', importPath: '$lib/components/ui/textarea/index.js',
    props: {
      placeholder: { type: 'text', label: 'Placeholder', default: 'Type here...' },
      disabled: { type: 'toggle', label: 'Disabled', default: false },
    },
  },
  'Label': { category: 'Form', icon: 'A', importName: 'Label', importPath: '$lib/components/ui/label/index.js',
    props: { text: { type: 'text', label: 'Text', default: 'Label' } },
  },
  'Select': { category: 'Form', icon: '▾', importNs: 'Select', importPath: '$lib/components/ui/select/index.js',
    props: { placeholder: { type: 'text', label: 'Placeholder', default: 'Select an option' } },
  },
  'Checkbox': { category: 'Form', icon: '☑', importName: 'Checkbox', importPath: '$lib/components/ui/checkbox/index.js',
    props: {
      label: { type: 'text', label: 'Label', default: 'Accept terms' },
      checked: { type: 'toggle', label: 'Checked', default: false },
    },
  },
  'Switch': { category: 'Form', icon: '◐', importName: 'Switch', importPath: '$lib/components/ui/switch/index.js',
    props: {
      label: { type: 'text', label: 'Label', default: 'Enable notifications' },
      checked: { type: 'toggle', label: 'On', default: false },
    },
  },
  'RadioGroup': { category: 'Form', icon: '◉', importNs: 'RadioGroup', importPath: '$lib/components/ui/radio-group/index.js',
    props: {
      options: { type: 'text', label: 'Options (comma-separated)', default: 'Option A, Option B, Option C' },
    },
  },

  // Data Display
  'Badge': { category: 'Data Display', icon: '●', importName: 'Badge', importPath: '$lib/components/ui/badge/index.js',
    props: {
      text: { type: 'text', label: 'Text', default: 'Badge' },
      variant: { type: 'select', label: 'Variant', options: ['default', 'secondary', 'outline', 'destructive'], default: 'default' },
    },
  },
  'Avatar': { category: 'Data Display', icon: '◉', importNs: 'Avatar', importPath: '$lib/components/ui/avatar/index.js',
    props: { initials: { type: 'text', label: 'Initials', default: 'AK' } },
  },
  'Progress': { category: 'Data Display', icon: '▰', importName: 'Progress', importPath: '$lib/components/ui/progress/index.js',
    props: { value: { type: 'text', label: 'Value (%)', default: '60' } },
  },
  'Skeleton': { category: 'Data Display', icon: '▬', importName: 'Skeleton', importPath: '$lib/components/ui/skeleton/index.js',
    props: {
      width: { type: 'text', label: 'Width', default: '100%' },
      height: { type: 'text', label: 'Height', default: '20px' },
    },
  },

  // Feedback
  'Alert': { category: 'Feedback', icon: '⚠', isContainer: false, importName: 'Alert', importPath: '$lib/components/ui/alert/index.js',
    props: {
      title: { type: 'text', label: 'Title', default: 'Heads up!' },
      description: { type: 'text', label: 'Description', default: 'This is an important message.' },
      variant: { type: 'select', label: 'Variant', options: ['default', 'destructive'], default: 'default' },
    },
  },

  // Navigation
  'Breadcrumb': { category: 'Navigation', icon: '›', importNs: 'Breadcrumb', importPath: '$lib/components/ui/breadcrumb/index.js',
    props: { items: { type: 'text', label: 'Items (comma-separated)', default: 'Home, Settings, Profile' } },
  },
  'Tabs': { category: 'Navigation', icon: '⊞', importNs: 'Tabs', importPath: '$lib/components/ui/tabs/index.js',
    props: { tabs: { type: 'text', label: 'Tabs (comma-separated)', default: 'General, Security, Billing' } },
  },
};

// ═══════════════════════════════════════════════════
// State
// ═══════════════════════════════════════════════════

let nodes = []; // flat list: { id, type, parentId, props }
let selectedId = null;
let nextId = 1;
let activeTab = 'props';

// ═══════════════════════════════════════════════════
// Palette Rendering
// ═══════════════════════════════════════════════════

function renderPalette() {
  const el = document.getElementById('palette-list');
  const categories = ['Layout', 'Form', 'Data Display', 'Feedback', 'Navigation'];
  let html = '';

  for (const cat of categories) {
    html += `<div class="palette-category"><div class="palette-category-title">${cat}</div>`;
    for (const [name, def] of Object.entries(COMPONENTS)) {
      if (def.category === cat) {
        html += `<button class="palette-item" onclick="addComponent('${name}')">
          <span class="icon">${def.icon}</span>${name}
        </button>`;
        // Show sub-parts indented below parent
        if (def.subParts) {
          for (const subName of def.subParts) {
            const subDef = COMPONENTS[subName];
            if (subDef) {
              html += `<button class="palette-item sub" onclick="addComponent('${subName}')">
                <span class="icon">${subDef.icon}</span>${subName}
              </button>`;
            }
          }
        }
      }
    }
    html += '</div>';
  }

  el.innerHTML = html;
}

// ═══════════════════════════════════════════════════
// Node Operations
// ═══════════════════════════════════════════════════

// Walk up the tree from a node to find an ancestor matching a type name
function findAncestorOfType(startNode, targetType) {
  let current = startNode;
  while (current) {
    if (current.type === targetType) return current.id;
    current = current.parentId ? nodes.find(n => n.id === current.parentId) : null;
  }
  return null; // no matching ancestor found
}

function addComponent(type) {
  const def = COMPONENTS[type];
  const props = {};
  if (def.props) {
    for (const [k, v] of Object.entries(def.props)) {
      props[k] = v.default;
    }
  }

  let parentId = null;

  if (selectedId !== null) {
    const sel = nodes.find(n => n.id === selectedId);
    if (sel) {
      // If adding a sub-part (e.g. Card.Content), find the matching parent type
      // so siblings don't nest inside each other
      if (def.partOf) {
        parentId = findAncestorOfType(sel, def.partOf);
      } else {
        const selDef = COMPONENTS[sel.type];
        if (selDef && selDef.isContainer) {
          parentId = selectedId;
        } else {
          parentId = sel.parentId;
        }
      }
    }
  }

  const node = { id: nextId++, type, parentId, props };
  nodes.push(node);
  selectedId = node.id;
  updateAll();
}

function deleteSelected() {
  if (selectedId === null) return;
  // Remove node and all descendants
  const toRemove = new Set();
  function collectDesc(id) {
    toRemove.add(id);
    nodes.filter(n => n.parentId === id).forEach(n => collectDesc(n.id));
  }
  collectDesc(selectedId);
  nodes = nodes.filter(n => !toRemove.has(n.id));
  selectedId = null;
  updateAll();
}

function moveUp() {
  if (selectedId === null) return;
  const idx = nodes.findIndex(n => n.id === selectedId);
  const node = nodes[idx];
  // Find siblings
  const siblings = nodes.filter(n => n.parentId === node.parentId);
  const sibIdx = siblings.findIndex(n => n.id === selectedId);
  if (sibIdx <= 0) return;
  // Swap in main array
  const prevSib = siblings[sibIdx - 1];
  const mainIdxPrev = nodes.findIndex(n => n.id === prevSib.id);
  const mainIdxCurr = nodes.findIndex(n => n.id === selectedId);
  [nodes[mainIdxPrev], nodes[mainIdxCurr]] = [nodes[mainIdxCurr], nodes[mainIdxPrev]];
  updateAll();
}

function moveDown() {
  if (selectedId === null) return;
  const node = nodes.find(n => n.id === selectedId);
  const siblings = nodes.filter(n => n.parentId === node.parentId);
  const sibIdx = siblings.findIndex(n => n.id === selectedId);
  if (sibIdx >= siblings.length - 1) return;
  const nextSib = siblings[sibIdx + 1];
  const mainIdxNext = nodes.findIndex(n => n.id === nextSib.id);
  const mainIdxCurr = nodes.findIndex(n => n.id === selectedId);
  [nodes[mainIdxNext], nodes[mainIdxCurr]] = [nodes[mainIdxCurr], nodes[mainIdxNext]];
  updateAll();
}

function clearAll() {
  nodes = [];
  selectedId = null;
  nextId = 1;
  updateAll();
}

// ═══════════════════════════════════════════════════
// Preview Rendering
// ═══════════════════════════════════════════════════

function getChildren(parentId) {
  return nodes.filter(n => n.parentId === parentId);
}

function renderNode(node) {
  const def = COMPONENTS[node.type];
  const sel = node.id === selectedId ? ' selected' : '';
  const click = `event.stopPropagation(); selectNode(${node.id})`;

  const childrenHtml = def.isContainer
    ? `<div class="container-children">${getChildren(node.id).map(renderNode).join('')}</div>`
    : '';

  switch (node.type) {
    case 'Card':
      return `<div class="prev-node prev-card${sel}" onclick="${click}">${childrenHtml || '<div style="padding:24px;color:var(--muted-foreground);font-size:13px;text-align:center;">Empty Card &mdash; add Card.Header, Card.Content, etc.</div>'}</div>`;
    case 'Card.Header':
      return `<div class="prev-node prev-card-header${sel}" onclick="${click}">${childrenHtml || '<span style="color:var(--muted-foreground);font-size:13px;">Empty Header</span>'}</div>`;
    case 'Card.Title':
      return `<div class="prev-node prev-card-title${sel}" onclick="${click}">${esc(node.props.text)}</div>`;
    case 'Card.Description':
      return `<div class="prev-node prev-card-description${sel}" onclick="${click}">${esc(node.props.text)}</div>`;
    case 'Card.Content':
      return `<div class="prev-node prev-card-content${sel}" onclick="${click}">${childrenHtml || '<span style="color:var(--muted-foreground);font-size:13px;">Empty Content</span>'}</div>`;
    case 'Card.Footer':
      return `<div class="prev-node prev-card-footer${sel}" onclick="${click}">${childrenHtml || '<span style="color:var(--muted-foreground);font-size:13px;">Empty Footer</span>'}</div>`;
    case 'Separator':
      return `<div class="prev-node${sel}" onclick="${click}"><div class="prev-separator"></div></div>`;
    case 'Field.Group':
      return `<div class="prev-node prev-field-group${sel}" onclick="${click}">${childrenHtml || '<span style="color:var(--muted-foreground);font-size:13px;">Empty Field Group</span>'}</div>`;
    case 'Field.Set':
      return `<div class="prev-node prev-field-set${sel}" onclick="${click}">${childrenHtml || '<span style="color:var(--muted-foreground);font-size:13px;">Empty Field Set</span>'}</div>`;
    case 'Field.Legend':
      return `<div class="prev-node prev-field-legend${sel}" onclick="${click}">${esc(node.props.text)}</div>`;
    case 'Field.Description':
      return `<div class="prev-node prev-field-description${sel}" onclick="${click}">${esc(node.props.text)}</div>`;
    case 'Field.Separator':
      return `<div class="prev-node${sel}" onclick="${click}"><div class="prev-separator"></div></div>`;
    case 'Text': {
      const styleMap = {
        heading: 'font-size:20px;font-weight:600;',
        subheading: 'font-size:16px;font-weight:600;',
        body: 'font-size:14px;',
        small: 'font-size:12px;',
        muted: 'font-size:14px;color:var(--muted-foreground);',
      };
      const s = styleMap[node.props.style] || styleMap.body;
      return `<div class="prev-node${sel}" onclick="${click}"><p style="${s}margin:0;color:var(--foreground);${node.props.style==='muted'?'color:var(--muted-foreground);':''}">${esc(node.props.text)}</p></div>`;
    }
    case 'Button': {
      const v = node.props.variant || 'default';
      const s = node.props.size !== 'default' ? ' ' + node.props.size : '';
      return `<div class="prev-node${sel}" onclick="${click}" style="display:inline-block;"><div class="prev-button ${v}${s}">${esc(node.props.text)}</div></div>`;
    }
    case 'Input': {
      const dis = node.props.disabled ? ' disabled' : '';
      return `<div class="prev-node${sel}" onclick="${click}"><input class="prev-input" type="${node.props.type}" placeholder="${esc(node.props.placeholder)}"${dis} readonly /></div>`;
    }
    case 'Textarea': {
      const dis = node.props.disabled ? ' disabled' : '';
      return `<div class="prev-node${sel}" onclick="${click}"><textarea class="prev-textarea" placeholder="${esc(node.props.placeholder)}"${dis} readonly></textarea></div>`;
    }
    case 'Label':
      return `<div class="prev-node prev-label${sel}" onclick="${click}">${esc(node.props.text)}</div>`;
    case 'Select':
      return `<div class="prev-node${sel}" onclick="${click}"><div class="prev-select">${esc(node.props.placeholder)}</div></div>`;
    case 'Checkbox':
      return `<div class="prev-node prev-checkbox-row${sel}" onclick="${click}"><input class="prev-checkbox" type="checkbox" ${node.props.checked ? 'checked' : ''} onclick="return false" /><span style="font-size:14px;">${esc(node.props.label)}</span></div>`;
    case 'Switch':
      return `<div class="prev-node prev-switch-row${sel}" onclick="${click}"><div class="prev-switch${node.props.checked ? ' on' : ''}"><div class="thumb"></div></div><span style="font-size:14px;">${esc(node.props.label)}</span></div>`;
    case 'RadioGroup': {
      const opts = (node.props.options || '').split(',').map(s => s.trim()).filter(Boolean);
      return `<div class="prev-node prev-radio-group${sel}" onclick="${click}">${opts.map((o, i) =>
        `<div class="prev-radio-row"><input class="prev-radio" type="radio" name="rg_${node.id}" ${i===0?'checked':''} onclick="return false" /><span style="font-size:14px;">${esc(o)}</span></div>`
      ).join('')}</div>`;
    }
    case 'Badge': {
      const v = node.props.variant || 'default';
      return `<div class="prev-node${sel}" onclick="${click}" style="display:inline-block;"><div class="prev-badge ${v}">${esc(node.props.text)}</div></div>`;
    }
    case 'Avatar':
      return `<div class="prev-node${sel}" onclick="${click}" style="display:inline-block;"><div class="prev-avatar">${esc(node.props.initials)}</div></div>`;
    case 'Progress': {
      const val = parseInt(node.props.value) || 0;
      return `<div class="prev-node${sel}" onclick="${click}"><div class="prev-progress"><div class="prev-progress-bar" style="width:${val}%"></div></div></div>`;
    }
    case 'Skeleton':
      return `<div class="prev-node${sel}" onclick="${click}"><div class="prev-skeleton" style="width:${node.props.width};height:${node.props.height};"></div></div>`;
    case 'Alert': {
      const v = node.props.variant || 'default';
      const iconSvg = v === 'destructive'
        ? '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>'
        : '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>';
      return `<div class="prev-node${sel}" onclick="${click}"><div class="prev-alert ${v}"><div class="prev-alert-icon">${iconSvg}</div><div class="prev-alert-content"><div class="prev-alert-title">${esc(node.props.title)}</div><div class="prev-alert-description">${esc(node.props.description)}</div></div></div></div>`;
    }
    case 'Breadcrumb': {
      const items = (node.props.items || '').split(',').map(s => s.trim()).filter(Boolean);
      return `<div class="prev-node prev-breadcrumb${sel}" onclick="${click}">${items.map((item, i) =>
        (i < items.length - 1)
          ? `<span class="prev-breadcrumb-item">${esc(item)}</span><span class="prev-breadcrumb-sep">/</span>`
          : `<span class="prev-breadcrumb-item current">${esc(item)}</span>`
      ).join('')}</div>`;
    }
    case 'Tabs': {
      const tabs = (node.props.tabs || '').split(',').map(s => s.trim()).filter(Boolean);
      return `<div class="prev-node${sel}" onclick="${click}"><div class="prev-tabs-list">${tabs.map((t, i) =>
        `<div class="prev-tab${i===0?' active':''}">${esc(t)}</div>`
      ).join('')}</div></div>`;
    }
    default:
      return `<div class="prev-node${sel}" onclick="${click}" style="padding:8px;border:1px dashed var(--border);border-radius:4px;font-size:13px;color:var(--muted-foreground);">${node.type}</div>`;
  }
}

function renderPreview() {
  const el = document.getElementById('preview');
  const roots = getChildren(null);

  if (roots.length === 0) {
    el.innerHTML = '<div class="preview-empty"><div>No components yet</div><div class="hint">Click a component in the left palette to start building</div></div>';
    return;
  }

  el.innerHTML = roots.map(renderNode).join('');
}

// ═══════════════════════════════════════════════════
// Selection & Props
// ═══════════════════════════════════════════════════

function selectNode(id) {
  selectedId = id;
  updateAll();
}

function renderProps() {
  const noSel = document.getElementById('no-selection');
  const form = document.getElementById('props-form');

  if (selectedId === null) {
    noSel.style.display = '';
    form.style.display = 'none';
    return;
  }

  const node = nodes.find(n => n.id === selectedId);
  if (!node) { selectedId = null; renderProps(); return; }

  noSel.style.display = 'none';
  form.style.display = '';

  const def = COMPONENTS[node.type];
  let html = `<div style="margin-bottom:12px;font-size:14px;font-weight:600;color:var(--ui-text);">${node.type}</div>`;

  if (def.props && Object.keys(def.props).length > 0) {
    for (const [key, prop] of Object.entries(def.props)) {
      html += `<div class="prop-group"><div class="prop-label">${prop.label}</div>`;

      if (prop.type === 'text') {
        html += `<input class="prop-input" value="${esc(node.props[key] || '')}" oninput="updateProp(${node.id}, '${key}', this.value)" />`;
      } else if (prop.type === 'select') {
        html += `<select class="prop-select" onchange="updateProp(${node.id}, '${key}', this.value)">`;
        for (const opt of prop.options) {
          html += `<option value="${opt}" ${node.props[key] === opt ? 'selected' : ''}>${opt}</option>`;
        }
        html += '</select>';
      } else if (prop.type === 'toggle') {
        html += `<div class="prop-toggle"><input type="checkbox" id="prop_${key}" ${node.props[key] ? 'checked' : ''} onchange="updateProp(${node.id}, '${key}', this.checked)" /><label for="prop_${key}">${prop.label}</label></div>`;
      }

      html += '</div>';
    }
  } else {
    html += '<div style="color:var(--ui-text-muted);font-size:13px;">No configurable props</div>';
  }

  if (def.isContainer) {
    html += '<div style="margin-top:16px;padding-top:12px;border-top:1px solid var(--ui-border);font-size:11px;color:var(--ui-text-muted);">Container — add components inside this element by selecting it then clicking a palette item.</div>';
  }

  form.innerHTML = html;
}

function updateProp(nodeId, key, value) {
  const node = nodes.find(n => n.id === nodeId);
  if (node) {
    node.props[key] = value;
    renderPreview();
    renderCode();
  }
}

// ═══════════════════════════════════════════════════
// Breadcrumb
// ═══════════════════════════════════════════════════

function renderBreadcrumb() {
  const el = document.getElementById('breadcrumb');
  if (selectedId === null) {
    el.innerHTML = '';
    return;
  }

  const parts = [];
  let node = nodes.find(n => n.id === selectedId);
  while (node) {
    parts.unshift(node.type);
    node = node.parentId ? nodes.find(n => n.id === node.parentId) : null;
  }

  el.innerHTML = parts.map((p, i) =>
    i === parts.length - 1
      ? `<span>${p}</span>`
      : `${p} <span style="color:var(--ui-text-muted);">›</span> `
  ).join('');
}

// ═══════════════════════════════════════════════════
// Code Generation
// ═══════════════════════════════════════════════════

function renderCode() {
  const el = document.getElementById('code-output');

  if (nodes.length === 0) {
    el.innerHTML = '<span class="syn-cmt">// Add components to see generated code</span>';
    return;
  }

  // Collect imports
  const nsImports = new Map(); // ns -> path
  const namedImports = new Map(); // path -> Set of names

  function collectImports(node) {
    const def = COMPONENTS[node.type];
    if (def.importNs) {
      nsImports.set(def.importNs, def.importPath);
    }
    if (def.importName) {
      if (!namedImports.has(def.importPath)) namedImports.set(def.importPath, new Set());
      namedImports.get(def.importPath).add(def.importName);
    }
  }

  nodes.forEach(collectImports);

  // Build script block
  let script = '';

  for (const [ns, path] of nsImports) {
    script += `<span class="syn-kw">import</span> * <span class="syn-kw">as</span> ${ns} <span class="syn-kw">from</span> <span class="syn-str">"${path}"</span>;\n`;
  }

  for (const [path, names] of namedImports) {
    const nameList = [...names].join(', ');
    script += `<span class="syn-kw">import</span> { ${nameList} } <span class="syn-kw">from</span> <span class="syn-str">"${path}"</span>;\n`;
  }

  // Build template
  function nodeToSvelte(node, indent) {
    const def = COMPONENTS[node.type];
    const pad = '  '.repeat(indent);
    const children = getChildren(node.id);
    const tagName = node.type; // e.g. "Card.Root" or "Button"
    const tag = node.type === 'Card' ? 'Card.Root' : node.type;

    let attrs = '';
    let content = '';
    let selfClose = false;

    switch (node.type) {
      case 'Card':
      case 'Card.Header':
      case 'Card.Content':
      case 'Card.Footer':
      case 'Field.Group':
      case 'Field.Set':
        content = children.map(c => nodeToSvelte(c, indent + 1)).join('\n');
        break;
      case 'Card.Title':
      case 'Card.Description':
      case 'Field.Legend':
      case 'Field.Description':
      case 'Label':
        content = `${pad}  ${esc(node.props.text || '')}`;
        break;
      case 'Field.Separator':
      case 'Separator':
        selfClose = true;
        break;
      case 'Text': {
        const classMap = { heading: 'text-xl font-semibold', subheading: 'text-base font-semibold', body: 'text-sm', small: 'text-xs', muted: 'text-sm text-muted-foreground' };
        const cls = classMap[node.props.style] || classMap.body;
        const tagEl = node.props.style === 'heading' ? 'h2' : node.props.style === 'subheading' ? 'h3' : 'p';
        return `${pad}<span class="syn-tag">&lt;${tagEl}</span> <span class="syn-attr">class</span>=<span class="syn-str">"${cls}"</span><span class="syn-tag">&gt;</span>${esc(node.props.text)}<span class="syn-tag">&lt;/${tagEl}&gt;</span>`;
      }
      case 'Button': {
        if (node.props.variant !== 'default') attrs += ` <span class="syn-attr">variant</span>=<span class="syn-str">"${node.props.variant}"</span>`;
        if (node.props.size !== 'default') attrs += ` <span class="syn-attr">size</span>=<span class="syn-str">"${node.props.size}"</span>`;
        content = `${pad}  ${esc(node.props.text)}`;
        break;
      }
      case 'Input': {
        if (node.props.type !== 'text') attrs += ` <span class="syn-attr">type</span>=<span class="syn-str">"${node.props.type}"</span>`;
        attrs += ` <span class="syn-attr">placeholder</span>=<span class="syn-str">"${esc(node.props.placeholder)}"</span>`;
        if (node.props.disabled) attrs += ` <span class="syn-attr">disabled</span>`;
        selfClose = true;
        break;
      }
      case 'Textarea': {
        attrs += ` <span class="syn-attr">placeholder</span>=<span class="syn-str">"${esc(node.props.placeholder)}"</span>`;
        if (node.props.disabled) attrs += ` <span class="syn-attr">disabled</span>`;
        selfClose = true;
        break;
      }
      case 'Select': {
        const inner = [
          `${pad}  <span class="syn-tag">&lt;Select.Trigger&gt;</span>`,
          `${pad}    <span class="syn-tag">&lt;Select.Value</span> <span class="syn-attr">placeholder</span>=<span class="syn-str">"${esc(node.props.placeholder)}"</span> <span class="syn-tag">/&gt;</span>`,
          `${pad}  <span class="syn-tag">&lt;/Select.Trigger&gt;</span>`,
          `${pad}  <span class="syn-tag">&lt;Select.Content&gt;</span>`,
          `${pad}    <span class="syn-tag">&lt;Select.Item</span> <span class="syn-attr">value</span>=<span class="syn-str">"option1"</span><span class="syn-tag">&gt;</span>Option 1<span class="syn-tag">&lt;/Select.Item&gt;</span>`,
          `${pad}    <span class="syn-tag">&lt;Select.Item</span> <span class="syn-attr">value</span>=<span class="syn-str">"option2"</span><span class="syn-tag">&gt;</span>Option 2<span class="syn-tag">&lt;/Select.Item&gt;</span>`,
          `${pad}  <span class="syn-tag">&lt;/Select.Content&gt;</span>`,
        ];
        content = inner.join('\n');
        break;
      }
      case 'Checkbox': {
        if (node.props.checked) attrs += ` <span class="syn-attr">checked</span>`;
        // Render as checkbox + label pair
        const lines = [
          `${pad}<span class="syn-tag">&lt;div</span> <span class="syn-attr">class</span>=<span class="syn-str">"flex items-center gap-2"</span><span class="syn-tag">&gt;</span>`,
          `${pad}  <span class="syn-tag">&lt;Checkbox</span>${attrs} <span class="syn-tag">/&gt;</span>`,
          `${pad}  <span class="syn-tag">&lt;Label&gt;</span>${esc(node.props.label)}<span class="syn-tag">&lt;/Label&gt;</span>`,
          `${pad}<span class="syn-tag">&lt;/div&gt;</span>`,
        ];
        return lines.join('\n');
      }
      case 'Switch': {
        const lines = [
          `${pad}<span class="syn-tag">&lt;div</span> <span class="syn-attr">class</span>=<span class="syn-str">"flex items-center gap-2"</span><span class="syn-tag">&gt;</span>`,
          `${pad}  <span class="syn-tag">&lt;Switch</span>${node.props.checked ? ` <span class="syn-attr">checked</span>` : ''} <span class="syn-tag">/&gt;</span>`,
          `${pad}  <span class="syn-tag">&lt;Label&gt;</span>${esc(node.props.label)}<span class="syn-tag">&lt;/Label&gt;</span>`,
          `${pad}<span class="syn-tag">&lt;/div&gt;</span>`,
        ];
        return lines.join('\n');
      }
      case 'RadioGroup': {
        const opts = (node.props.options || '').split(',').map(s => s.trim()).filter(Boolean);
        const lines = [`${pad}<span class="syn-tag">&lt;RadioGroup.Root&gt;</span>`];
        for (const opt of opts) {
          const val = opt.toLowerCase().replace(/\s+/g, '_');
          lines.push(`${pad}  <span class="syn-tag">&lt;div</span> <span class="syn-attr">class</span>=<span class="syn-str">"flex items-center gap-2"</span><span class="syn-tag">&gt;</span>`);
          lines.push(`${pad}    <span class="syn-tag">&lt;RadioGroup.Item</span> <span class="syn-attr">value</span>=<span class="syn-str">"${val}"</span> <span class="syn-tag">/&gt;</span>`);
          lines.push(`${pad}    <span class="syn-tag">&lt;Label&gt;</span>${esc(opt)}<span class="syn-tag">&lt;/Label&gt;</span>`);
          lines.push(`${pad}  <span class="syn-tag">&lt;/div&gt;</span>`);
        }
        lines.push(`${pad}<span class="syn-tag">&lt;/RadioGroup.Root&gt;</span>`);
        return lines.join('\n');
      }
      case 'Badge': {
        if (node.props.variant !== 'default') attrs += ` <span class="syn-attr">variant</span>=<span class="syn-str">"${node.props.variant}"</span>`;
        content = `${pad}  ${esc(node.props.text)}`;
        break;
      }
      case 'Avatar': {
        const lines = [
          `${pad}<span class="syn-tag">&lt;Avatar.Root&gt;</span>`,
          `${pad}  <span class="syn-tag">&lt;Avatar.Fallback&gt;</span>${esc(node.props.initials)}<span class="syn-tag">&lt;/Avatar.Fallback&gt;</span>`,
          `${pad}<span class="syn-tag">&lt;/Avatar.Root&gt;</span>`,
        ];
        return lines.join('\n');
      }
      case 'Progress': {
        attrs += ` <span class="syn-attr">value</span>={${node.props.value || 0}}`;
        selfClose = true;
        break;
      }
      case 'Skeleton': {
        attrs += ` <span class="syn-attr">class</span>=<span class="syn-str">"w-full h-5"</span>`;
        selfClose = true;
        break;
      }
      case 'Alert': {
        if (node.props.variant !== 'default') attrs += ` <span class="syn-attr">variant</span>=<span class="syn-str">"${node.props.variant}"</span>`;
        const lines = [
          `${pad}<span class="syn-tag">&lt;Alert${attrs}&gt;</span>`,
          `${pad}  <span class="syn-tag">&lt;AlertTitle&gt;</span>${esc(node.props.title)}<span class="syn-tag">&lt;/AlertTitle&gt;</span>`,
          `${pad}  <span class="syn-tag">&lt;AlertDescription&gt;</span>${esc(node.props.description)}<span class="syn-tag">&lt;/AlertDescription&gt;</span>`,
          `${pad}<span class="syn-tag">&lt;/Alert&gt;</span>`,
        ];
        return lines.join('\n');
      }
      case 'Breadcrumb': {
        const items = (node.props.items || '').split(',').map(s => s.trim()).filter(Boolean);
        const lines = [`${pad}<span class="syn-tag">&lt;Breadcrumb.Root&gt;</span>`, `${pad}  <span class="syn-tag">&lt;Breadcrumb.List&gt;</span>`];
        items.forEach((item, i) => {
          lines.push(`${pad}    <span class="syn-tag">&lt;Breadcrumb.Item&gt;</span>`);
          if (i < items.length - 1) {
            lines.push(`${pad}      <span class="syn-tag">&lt;Breadcrumb.Link</span> <span class="syn-attr">href</span>=<span class="syn-str">"#"</span><span class="syn-tag">&gt;</span>${esc(item)}<span class="syn-tag">&lt;/Breadcrumb.Link&gt;</span>`);
          } else {
            lines.push(`${pad}      <span class="syn-tag">&lt;Breadcrumb.Page&gt;</span>${esc(item)}<span class="syn-tag">&lt;/Breadcrumb.Page&gt;</span>`);
          }
          lines.push(`${pad}    <span class="syn-tag">&lt;/Breadcrumb.Item&gt;</span>`);
          if (i < items.length - 1) {
            lines.push(`${pad}    <span class="syn-tag">&lt;Breadcrumb.Separator /&gt;</span>`);
          }
        });
        lines.push(`${pad}  <span class="syn-tag">&lt;/Breadcrumb.List&gt;</span>`, `${pad}<span class="syn-tag">&lt;/Breadcrumb.Root&gt;</span>`);
        return lines.join('\n');
      }
      case 'Tabs': {
        const tabs = (node.props.tabs || '').split(',').map(s => s.trim()).filter(Boolean);
        const lines = [
          `${pad}<span class="syn-tag">&lt;Tabs.Root</span> <span class="syn-attr">value</span>=<span class="syn-str">"${tabs[0]?.toLowerCase().replace(/\s+/g, '_') || 'tab1'}"</span><span class="syn-tag">&gt;</span>`,
          `${pad}  <span class="syn-tag">&lt;Tabs.List&gt;</span>`,
        ];
        tabs.forEach(t => {
          const val = t.toLowerCase().replace(/\s+/g, '_');
          lines.push(`${pad}    <span class="syn-tag">&lt;Tabs.Trigger</span> <span class="syn-attr">value</span>=<span class="syn-str">"${val}"</span><span class="syn-tag">&gt;</span>${esc(t)}<span class="syn-tag">&lt;/Tabs.Trigger&gt;</span>`);
        });
        lines.push(`${pad}  <span class="syn-tag">&lt;/Tabs.List&gt;</span>`);
        tabs.forEach(t => {
          const val = t.toLowerCase().replace(/\s+/g, '_');
          lines.push(`${pad}  <span class="syn-tag">&lt;Tabs.Content</span> <span class="syn-attr">value</span>=<span class="syn-str">"${val}"</span><span class="syn-tag">&gt;</span>${esc(t)} content<span class="syn-tag">&lt;/Tabs.Content&gt;</span>`);
        });
        lines.push(`${pad}<span class="syn-tag">&lt;/Tabs.Root&gt;</span>`);
        return lines.join('\n');
      }
      default:
        return `${pad}<span class="syn-tag">&lt;${tag} /&gt;</span>`;
    }

    if (selfClose) {
      return `${pad}<span class="syn-tag">&lt;${tag}</span>${attrs} <span class="syn-tag">/&gt;</span>`;
    }

    if (content) {
      return `${pad}<span class="syn-tag">&lt;${tag}</span>${attrs}<span class="syn-tag">&gt;</span>\n${content}\n${pad}<span class="syn-tag">&lt;/${tag}&gt;</span>`;
    }

    return `${pad}<span class="syn-tag">&lt;${tag}</span>${attrs} <span class="syn-tag">/&gt;</span>`;
  }

  // Build template for root nodes
  const roots = getChildren(null);
  const templateParts = roots.map(n => nodeToSvelte(n, 0));

  // Plain text for copy
  const plainScript = script.replace(/<[^>]*>/g, '');
  const plainTemplate = templateParts.join('\n\n').replace(/<[^>]*>/g, '').replace(/&lt;/g, '<').replace(/&gt;/g, '>').replace(/&amp;/g, '&').replace(/&quot;/g, '"');

  // Store plain text for copy
  window._generatedCode = `<script>\n${plainScript}<\/script>\n\n${plainTemplate}`;

  // Highlighted output
  el.innerHTML = `<span class="syn-tag">&lt;script&gt;</span>\n${script}<span class="syn-tag">&lt;/script&gt;</span>\n\n${templateParts.join('\n\n')}`;
}

// ═══════════════════════════════════════════════════
// Presets
// ═══════════════════════════════════════════════════

function loadPreset(name) {
  nodes = [];
  selectedId = null;
  nextId = 1;

  switch (name) {
    case 'login': {
      const card = { id: nextId++, type: 'Card', parentId: null, props: {} };
      const header = { id: nextId++, type: 'Card.Header', parentId: card.id, props: {} };
      const title = { id: nextId++, type: 'Card.Title', parentId: header.id, props: { text: 'Sign In' } };
      const desc = { id: nextId++, type: 'Card.Description', parentId: header.id, props: { text: 'Enter your credentials to access your account' } };
      const content = { id: nextId++, type: 'Card.Content', parentId: card.id, props: {} };
      const emailLabel = { id: nextId++, type: 'Label', parentId: content.id, props: { text: 'Email' } };
      const emailInput = { id: nextId++, type: 'Input', parentId: content.id, props: { placeholder: 'name@company.com', type: 'email', disabled: false } };
      const passLabel = { id: nextId++, type: 'Label', parentId: content.id, props: { text: 'Password' } };
      const passInput = { id: nextId++, type: 'Input', parentId: content.id, props: { placeholder: 'Enter password', type: 'password', disabled: false } };
      const footer = { id: nextId++, type: 'Card.Footer', parentId: card.id, props: {} };
      const btn = { id: nextId++, type: 'Button', parentId: footer.id, props: { text: 'Sign In', variant: 'default', size: 'default' } };
      nodes = [card, header, title, desc, content, emailLabel, emailInput, passLabel, passInput, footer, btn];
      break;
    }
    case 'settings': {
      const card = { id: nextId++, type: 'Card', parentId: null, props: {} };
      const header = { id: nextId++, type: 'Card.Header', parentId: card.id, props: {} };
      const title = { id: nextId++, type: 'Card.Title', parentId: header.id, props: { text: 'Application Settings' } };
      const desc = { id: nextId++, type: 'Card.Description', parentId: header.id, props: { text: 'Configure your display and formatting preferences' } };
      const content = { id: nextId++, type: 'Card.Content', parentId: card.id, props: {} };
      const fg = { id: nextId++, type: 'Field.Group', parentId: content.id, props: {} };
      const fs = { id: nextId++, type: 'Field.Set', parentId: fg.id, props: {} };
      const legend = { id: nextId++, type: 'Field.Legend', parentId: fs.id, props: { text: 'Number Formatting' } };
      const fdesc = { id: nextId++, type: 'Field.Description', parentId: fs.id, props: { text: 'Set how numbers appear throughout the application' } };
      const sel = { id: nextId++, type: 'Select', parentId: fs.id, props: { placeholder: 'Decimal separator' } };
      const sel2 = { id: nextId++, type: 'Select', parentId: fs.id, props: { placeholder: 'Thousands separator' } };
      const sep = { id: nextId++, type: 'Separator', parentId: content.id, props: {} };
      const sw = { id: nextId++, type: 'Switch', parentId: content.id, props: { label: 'Use metric units', checked: true } };
      const footer = { id: nextId++, type: 'Card.Footer', parentId: card.id, props: {} };
      const btnCancel = { id: nextId++, type: 'Button', parentId: footer.id, props: { text: 'Cancel', variant: 'outline', size: 'default' } };
      const btnSave = { id: nextId++, type: 'Button', parentId: footer.id, props: { text: 'Save Changes', variant: 'default', size: 'default' } };
      nodes = [card, header, title, desc, content, fg, fs, legend, fdesc, sel, sel2, sep, sw, footer, btnCancel, btnSave];
      break;
    }
    case 'profile': {
      const card = { id: nextId++, type: 'Card', parentId: null, props: {} };
      const header = { id: nextId++, type: 'Card.Header', parentId: card.id, props: {} };
      const av = { id: nextId++, type: 'Avatar', parentId: header.id, props: { initials: 'JD' } };
      const title = { id: nextId++, type: 'Card.Title', parentId: header.id, props: { text: 'Jane Doe' } };
      const desc = { id: nextId++, type: 'Card.Description', parentId: header.id, props: { text: 'Sustainability Manager' } };
      const content = { id: nextId++, type: 'Card.Content', parentId: card.id, props: {} };
      const badge = { id: nextId++, type: 'Badge', parentId: content.id, props: { text: 'Tenant Admin', variant: 'secondary' } };
      const prog = { id: nextId++, type: 'Progress', parentId: content.id, props: { value: '75' } };
      const label = { id: nextId++, type: 'Label', parentId: content.id, props: { text: 'Profile completion: 75%' } };
      nodes = [card, header, av, title, desc, content, badge, prog, label];
      break;
    }
    case 'alert': {
      const alert1 = { id: nextId++, type: 'Alert', parentId: null, props: { title: 'Reporting period started', description: 'Your FY2025 Q4 reporting period is now open. Emission entries can be submitted.', variant: 'default' } };
      const alert2 = { id: nextId++, type: 'Alert', parentId: null, props: { title: 'Missing emission data', description: 'Scope 1 data for 3 facilities has not been submitted for the current period.', variant: 'destructive' } };
      nodes = [alert1, alert2];
      break;
    }
    case 'empty': {
      nodes = [];
      break;
    }
  }

  updateAll();
}

// ═══════════════════════════════════════════════════
// Tab Switching
// ═══════════════════════════════════════════════════

function switchTab(tab) {
  activeTab = tab;
  document.querySelectorAll('.right-tab').forEach(t => t.classList.remove('active'));
  document.querySelector(`.right-tab:${tab === 'props' ? 'first-child' : 'last-child'}`).classList.add('active');
  document.getElementById('props-panel').classList.toggle('hidden', tab !== 'props');
  document.getElementById('code-panel').classList.toggle('hidden', tab !== 'code');
}

// ═══════════════════════════════════════════════════
// Copy
// ═══════════════════════════════════════════════════

function copyCode() {
  const code = window._generatedCode || '';
  navigator.clipboard.writeText(code).then(() => {
    const btn = document.getElementById('copy-btn');
    btn.textContent = 'Copied!';
    btn.classList.add('copied');
    setTimeout(() => { btn.textContent = 'Copy'; btn.classList.remove('copied'); }, 1500);
  });
}

// ═══════════════════════════════════════════════════
// Toolbar
// ═══════════════════════════════════════════════════

function updateToolbar() {
  document.getElementById('btn-move-up').disabled = selectedId === null;
  document.getElementById('btn-move-down').disabled = selectedId === null;
  document.getElementById('btn-delete').disabled = selectedId === null;
}

document.getElementById('btn-move-up').addEventListener('click', moveUp);
document.getElementById('btn-move-down').addEventListener('click', moveDown);
document.getElementById('btn-delete').addEventListener('click', deleteSelected);
document.getElementById('btn-clear').addEventListener('click', clearAll);

// Click canvas background to deselect
document.getElementById('preview').addEventListener('click', (e) => {
  if (e.target === document.getElementById('preview') || e.target.closest('.preview-empty')) {
    selectedId = null;
    updateAll();
  }
});

// ═══════════════════════════════════════════════════
// Helpers
// ═══════════════════════════════════════════════════

function esc(str) {
  return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
}

// ═══════════════════════════════════════════════════
// Master update
// ═══════════════════════════════════════════════════

function updateAll() {
  renderPreview();
  renderProps();
  renderCode();
  renderBreadcrumb();
  updateToolbar();
}

// Expose to inline handlers
window.selectNode = selectNode;
window.updateProp = updateProp;
window.loadPreset = loadPreset;

// ═══════════════════════════════════════════════════
// Init
// ═══════════════════════════════════════════════════

renderPalette();
loadPreset('login'); // Start with a useful example
</script>

</body>
</html>
